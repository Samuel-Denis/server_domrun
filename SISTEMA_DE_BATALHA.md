⚔️ Sistema de Batalhas PvP e Ligas (ELO System)Este documento descreve a lógica de matchmaking, fórmulas de pontuação e estrutura de dados para o modo multiplayer do game.1. Arquitetura de Matchmaking (WebSocket)Para batalhas em tempo real, use WebSockets (@nestjs/websockets).Fluxo de Emparelhamento:Fila de Espera: O jogador envia um evento join_queue. O servidor o coloca em uma fila (sugestão: use Redis para filas rápidas).Filtro de Troféus: O servidor busca jogadores com uma diferença máxima de ±200 troféus.Criação da Sala: Ao encontrar um par, o servidor emite match_found com o battle_id e os dados do oponente.2. A Fórmula de Pontuação (Battle Score - BS)Para evitar que apenas a distância ganhe, usamos uma média ponderada entre Distância e Pace.Pesos Sugeridos:Distância (D): 60% da nota.Pace (P): 40% da nota.Cálculo do Battle Score ($BS$):O sistema converte o Pace em uma "Nota de Velocidade".Pace alvo (mínimo para pontuação cheia): 4:00 min/km.Pace limite (caminhada/mínimo): 12:00 min/km.$$BS = (Distância\_Metros \times 0.6) + \left( \frac{720 - Pace\_Segundos}{720 - 240} \times 1000 \times 0.4 \right)$$Nota: Se o Pace for pior que 12:00 min/km ($720s$), a nota de velocidade é zero. Se for melhor que 4:00 min/km ($240s$), a nota é máxima.3. Sistema de Troféus e LigasDistribuição de LigasLigaFaixa de TroféusMultiplicador de Recompensa (XP)Bronze (I, II, III)0 - 4991.0xPrata (I, II, III)500 - 9991.2xOuro (I, II, III)1.000 - 1.9991.5xCristal (I, II, III)2.000 - 2.9991.8xMestre3.000+2.2xGanho de Troféus ($T$)Use uma variação do sistema ELO:Vitoria: $+ (25 \pm \text{diferença de rank})$Derrota: $- (15 \pm \text{diferença de rank})$4. Estrutura do Banco de Dados Tabela: battlesCampoTipoDescriçãoidUUIDIdentificador único da batalha.player1_idUUIDFK para o primeiro jogador.player2_idUUIDFK para o segundo jogador.statusEnumsearching, in_progress, finished, cancelled.winner_idUUIDID do jogador que venceu.modeStringtimed (ex: 15 min) ou distance (ex: 5km).p1_scoreFloatScore final calculado do Jogador 1.p2_scoreFloatScore final calculado do Jogador 2.Tabela: users (Campos Adicionais)CampoTipoDescriçãotrophiesIntegerQuantidade atual de troféus.leagueStringNome da liga atual (ex: 'Prata II').win_streakIntegerContador de vitórias seguidas (para bônus).5. Regras Anti-Cheat (Validação de Corrida)Para manter a integridade das ligas:Velocidade Humana: Se o pace médio for menor que 2:30 min/km, marcar como "Suspeito" e invalidar vitória (prevenção contra bike/carro).GPS Jump: Se a distância entre dois pontos capturados em 5 segundos for > 100m, descartar o trecho (prevenção contra Fake GPS).Tempo Mínimo: Batalhas com menos de 3 minutos não geram troféus.6. Lógica de Encerramento (Backend Side)Ao final do tempo/distância:O servidor recebe o sync final de ambos os dispositivos.Calcula o $BS$ de cada um.Determina o vencedor.Atualiza os troféus de ambos no banco em uma Transaction única.Verifica se o usuário subiu ou desceu de liga.Envia o evento battle_result via Socket com o resumo.